provider kubernetes{
    load_config_file = "false"

    host = "https://142.68.130.126"
    client_certificate = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lJUkI5RWJPdjZ1Uzh3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TURBNE1qVXhNekEwTkRaYUZ3MHlNVEE0TWpVeE16QTBORGRhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXNQc1RVcWRFSEtxUFlhcDcKaXJvcnJ2ZElWc1g5NE1tUVk1NlI4R1BjNytxL0IwNVlleXFEdWVsT2tHanJobjlxd1FvK3MvWHNxZnVzelphZgpMa0kvdmoyTStxS3JPVHFYYUJrVUp3dGVlbCtFQzU2WjhoMGpzUjdBOGdTcUF2bit6ZW1oTlNRdEJIZFJ0UEx4ClpsWXVlU2JsWWRsL0lYSXJIcnRyb3pOd1plN0YwNm1KRUxRLzMvK2Y3RjBEZGMyank5aDVJcG50UUtONWRMWXYKclh0VkRMYlF0Z0piY0ZRdHE1VDV1b2RMeVFTVzVCOSsyaWQ1bHVvazhwUVduUFI0cE1SK1A2SXZKRElFUkZRVgo5SEpRbGtTRlg4a2dEUTdJWnFGRnhkUkYrSlRnYkxmWnFPVkpwcWlQeWFtV2dKME41RHR3TTJDcTIySWVka1hsClpnZmxod0lEQVFBQm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFDb3orRDhQRUtPQlVvTjFYekdkTktVMkI5VUxORFA2UlUzbwpxeWVxMTl6bm8zdFFBdWFBMmRPVUViZkVlRTdBcFV1ekE2ZWh3UGNXMHlsUTdCbTdQbjBvbXpvZHZ3bnpNOXF1CncrUVdVanMyL1NVV0dseWViZEdJOEJMUmpQdWFtYk9WTEI4S25wa1NSK0ppQ0pGU2JLUEVIOHFOWCtWeEtUWEYKQVdMVmVxUGhaUHcxQ0cyWTNMdzY3UXFGaTFQSkJFS2t2QkcwaWVxUk14cDNNcUJMY2Q4MEV3cXdTankrUmpwTQpiMFVXUkdFNFBiUHROUDVEckpiUnZOM010cDltWGpqdnRJa2JjUWtPSHhqMHA2NHMwYyswR0RsV21nNE5WRHQ4CmZ6eWlUTk16bnRUWUcxU1VheG5DalpsSXRPckpBOTZmK3hNcEkxYnpxREVjTnNOV2QyOD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
    client_key = "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc1BzVFVxZEVIS3FQWWFwN2lyb3JydmRJVnNYOTRNbVFZNTZSOEdQYzcrcS9CMDVZCmV5cUR1ZWxPa0dqcmhuOXF3UW8rcy9Yc3FmdXN6WmFmTGtJL3ZqMk0rcUtyT1RxWGFCa1VKd3RlZWwrRUM1NloKOGgwanNSN0E4Z1NxQXZuK3plbWhOU1F0QkhkUnRQTHhabFl1ZVNibFlkbC9JWElySHJ0cm96TndaZTdGMDZtSgpFTFEvMy8rZjdGMERkYzJqeTloNUlwbnRRS041ZExZdnJYdFZETGJRdGdKYmNGUXRxNVQ1dW9kTHlRU1c1QjkrCjJpZDVsdW9rOHBRV25QUjRwTVIrUDZJdkpESUVSRlFWOUhKUWxrU0ZYOGtnRFE3SVpxRkZ4ZFJGK0pUZ2JMZloKcU9WSnBxaVB5YW1XZ0owTjVEdHdNMkNxMjJJZWRrWGxaZ2ZsaHdJREFRQUJBb0lCQUYycWRCNlJjZ1h0NnZhWQpvTXZhSGhaNnYybFZYamtpMUcwMDFpNHczQlNKMjlKRkQ2VVg2aUZ4cmVmVjc1aitSSVNvSkdsZ0pZSU5OZmFVCjJlaEVuYkhVcDVGYW1GNHdlVU5aeW9Xamlid2dZeVUzS21pdUxWNm5WUnlCaFcwUDNHQWtYdkplRkFsQ0VSZEEKWUt4MXZpRFdpaDRRV3kxYlhDRG10bC9vY0hzeFV5a05Ea05TL2ZUeW9hSGxoUktCTmd3Z2pIR3I5ckdsdEZzcQp6VXRsZ25XSVdYT0ZsWVZndGdreHcxbkEreU5tUzZrVW0waXRjemlOUjMyWG1PZDd2TGRIYWV1bXp1ZmxTbFMxCmhlQ3ErSHJxV0pWaWdWdC9DUHAwKzFqTURHMkxNU3FLQnhHZnN2WUthdEdpazZaT3J3U0xDTFVyNjRGbGdSdmsKclRZTjZYa0NnWUVBM3lQU2lGa05OS2R1Q1VibVpWaEJ3SXRjQUJ0TWo2dVlOSWE2ZXFZWUNRamsvenBVek5XZwpzMFV0bXRvZHpXRnNaYWQ3U040OEZoSkt5MWhMeFNwUklFRTB3clJlRWI0bDIrRmRhT0xiVGNWOHd4K1JZYyt6CjduQ3NRSTh0aDlzMVhnQitUSURJTzhJTDdxdng3R0lPWWZxeVZocHN5b2lEb1hVZzZ4MmorTU1DZ1lFQXl3c1gKNkE0OXU5ZUQ3Kzh1UjQzaTI2SHNCeXdLVnE4aHhBRVpIYW5yaERRM1ltZURlckxrc25GRkNmVXI3TGJIYWVjNAo5WVRSbzJBL0luM3BEeHYvbi9XbG5Xdy9ONkhCaVg2ZXhIYlRLYWRZcFZlejJDVmRXM3N6anYrTktOQTE1aTYwCmhGYmRXTmEwS3VCdXRpTFNKcWJkZmJ4T0tOWTlBbVNsT1dIcGMrMENnWUE3ZGhoTUxTN1BzUzRwV3JOYW5rSW4KUlB1bks1OGpTZDZ0WUptZ3hWSHlWbVJ2ZnVQS0VjTlpBajQ4M1pMRGdBcWFyQjYyTkVKZXYxRWZEdEJpSWZ5cwpVN1B6am96aXZZRHBMd3p0UGthaVd0WDhTUlU4czFTSFhZOEpSUjRrN2MweTEzN1FkQ0RuaTdZU1M4K1Q1aTFlCi9xYzNPcU55OVIzZWtJL05GNER5Y1FLQmdRQy9HTXpDUWcwR0t0dHBTYkpEOUIxTVcwUmFwNjkvVUVzMlAxWlYKSGVTa3c4UlFvRjRWY0NOZ2Nzem9oMUIwOUw0UVJXZk5ZOWt1cTlvZjYyTWJMbDNUUGc1R2NHZTdRMGwwejdBNwo5aDNkdVR2c09mUHcvWkcxRk9vOHJ2WTdNR05hSmlFTjRQZG9zb0pWVEcvR2lsVkJ2WkQrMHVpNDlKSHRHNjZKCnFFWmhMUUtCZ1FDUS9Bb0xCY0RhWFlzSUMyblpYMENhWkk2czlyRkprZ1J2U3dkUHRDZlpOakVTRUQvQjFUcDkKeHMrdE94RDJ2dHB5cGFJNCtiaE5tMFErdWVMbWlHSXE1cnVJMEFqRy9Tdkt1WE5RU1pmMDBqWm9kKzc0QXBrSQpKYVVSRjVlOGxzTWlqTmk5MWVkMHJSTkVveGR2UGwyMitqS3dZbmF3VXlHeGJaWHpuaStHdkE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo="
    cluster_ca_certificate = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01EZ3lOVEV6TURRME5sb1hEVE13TURneU16RXpNRFEwTmxvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT09XClZqWjBLbjBXTkQyUmdCU3V4SjRNcUwwN0hmdG9Sbm9FUi9sdlNMZ3M5cmRpMVRoUVNFNXorTEFGdlRuS2VZcmIKNWZyTm4vR2t5YWhzellwcHFrTnVqOUhNaGhsV1hXL2xJejcwdERwOHFXU3YxMkd0U1A1cVZKVlExZkJVR1NLNQo1aEVaR0VYdGJuMGRjbkZzQ0RUUzFscldIOGkxWEZGSVJnK041QmdBU09nN3BESnFXK0kyZmlWNTVRSWVDTjF3Clc3bEFQODYwN0VpNlU2d1RoUjJxTGZ1YmswQ09BdDdoUHFYNEZSVDgrSlc3NHJvQWYvNjRpb1lDYlNMOXVSWEIKUTFDSVBKUmk4N2svdVJjUXlDM2t4Nk5FWTJpUVdoaU1yT3F6eDBIQ2RSMzRvYVV3VXcvU0QzVVZWbU13a3NMQQo1c2dTaFBwWlNXRHVlY1dUcmJrQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFMUFFmaG9tY1V2Z29RaWpwRlUwaDBZbWhVei8KdmpBZ2VkaG1pTlBnR2dHLzIvdWw0MisvTUNtTk1tNDI0UGI4eXBQN3hFdGpNYVQxWnRPUDExS0tUZjh4aDZmNgppNHl3YXpLUzFDSzJuVDhRUEhhZ2dDRmZJK203VktqTVIwWlBta3pRd045WW4xZzhKbklqZmg5dWtDNElUcEVmCmhRNEw5S0VTdUpncmNYWGpQVTNCaU94OXRBQzB3OFIyUWdPU2lDNHZSUkdJeWVMZWJnSkk5QVErWDBvTmcrS2cKQUkrSmEzby9vcVBwVUdwaXRPaXhKWUZLZ0tBQzJlWi91YXFieWxyNFpsQlBhTDA4WCsxRnlaUG0zVnhyZHF0egpuOXkwZTFhcHI4bVBIbXlOc3dKa1loWmk1ZnpPN1JoVDNhUXkwbVZMV1EyU3l5czBmMXZuUDgxdCtGQT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
}

# Deploy Kafka
resource "kubernetes_deployment" "kafka" {
    metadata{
        name = "kafka-deployment"
        labels = {
            app = "kafka"
        }
    }
    depends_on = [kubernetes_deployment.zookeeper]
    spec{
        replicas = 1

        selector{
            match_labels = {
                app = "kafka"
            }
        }


        #Kafka pod
        template{
            metadata{
                name="kafka"
                labels = {
                    app = "kafka"
                }
            }

            spec{

                # Kafka container
                container{
                    image = "bitnami/kafka:2.5.0"
                    name = "kafka-server"
                    
                    # Kafka Environment variables
                    env{
                        name = "KAFKA_BROKER_ID"
                        value = 1
                    }

                    env{
                        name = "KAFKA_ZOOKEEPER_CONNECT"
                        value = "zoo1:2181"
                    }
                     
                    env{
                        name = "ALLOW_PLAINTEXT_LISTENER"
                        value = "yes"
                    }

                    env{
                        name = "KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP"
                        value = "CLIENT:PLAINTEXT,PLAINTEXT:PLAINTEXT"
                    }

                    env{
                        name = "KAFKA_CFG_LISTENERS"
                        value = "CLIENT://:9092,PLAINTEXT://:9093"
                    }

                    env{
                        name = "KAFKA_CFG_ADVERTISED_LISTENERS"
                        value = "CLIENT://localhost:9092,PLAINTEXT://kafka:9093"
                    }

                    env{
                        name = "KAFKA_INTER_BROKER_LISTENER_NAME"
                        value = "PLAINTEXT"
                    }

                    env{
                        name="KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE"
                        value="TRUE"
                    }

                    port{
                        container_port = 9092
                    }
                    port{
                        container_port = 9093
                    }
                }
            }
        }    
    }
}

# Deploy Elassandra 
resource "kubernetes_deployment" "elassandra"{
    metadata{
        name = "elassandra-deployment"
        labels = {
            app = "elassandra"
        }
    }
    spec{
        replicas = 1

        selector{
            match_labels = {
                app = "elassandra"
            }
        }

        #Elassandra pod
        template{
            metadata{
                name="elassandra"
                labels = {
                    app = "elassandra"
                }
            }

            spec{

                #Elassandra container
                container{
                    image = "strapdata/elassandra:6.8.4"
                    name = "elassandra"

                    #Elassandra Environment variables
                    env{
                        name = "CASSANDRA_LISTEN_ADDRESS"
                        value = "localhost"
                    }

                    #Elassandra ports
                    port{
                        container_port = 9300 # Elastic Search Transport
                    }

                    port{
                        container_port = 9200 # Elastic Search HTTP
                    }

                    port {
                        container_port = 9160 # Thrift service
                    }

                    port {
                        container_port = 9142 # Encrypted CQL
                    }

                    port {
                        container_port = 9042 # CQL
                    }

                    port {
                        container_port = 7199 # JMX
                    }

                    port {
                        container_port = 7001 # TLS intra-node communication
                    }

                    port {
                        container_port = 7000 # Intra-node communication
                    }

                    readiness_probe{
                        exec{
                            command =  [ "/bin/bash", "-c", "/ready-probe.sh" ]
                        }
                        initial_delay_seconds = 15
                        timeout_seconds = 5
                    }
                        
                }
            }
        }
    }
}

# Deploy Grafana 
resource "kubernetes_deployment" "grafana"{
    metadata{
        name = "grafana-deployment"
        labels = {
            app = "grafana"
        }
    }
    spec{
        replicas = 1

        selector{
            match_labels = {
                app = "grafana"
            }
        }

        #Grafana pod
        template{
            metadata{
                name="grafana"
                labels = {
                    app = "grafana"
                }
            }

            spec{

                #Grafana container
                container{
                    image="grafana/grafana:7.1.0"
                    name="grafana"

                    port{
                        container_port = 3000
                    }

                    env{
                        name = "GF_INSTALL_PLUGINS"
                        value = "natel-plotly-panel"
                    }

                }

            }
        }
    }
}

/*Grafana volume
resource "kubernetes_persistent_volume" "grafana_volume" {
  metadata {
    name = "grafana-volume"
  }
  spec {
    capacity = {
      storage = "10Gi"
    }
    access_modes = ["ReadWriteOnce"]
    persistent_volume_source {
        host_path{
            path = "/home"
            type = "DirectoryOrCreate"
        }
    }
    storage_class_name = "standard"
  }
}

resource "kubernetes_persistent_volume_claim" "grafana_claim" {
  metadata {
    name = "grafana-volume-claim"
  }
  spec {
    access_modes = ["ReadWriteOnce"]
    resources {
      requests = {
        storage = "10Gi"
      }
    }
    volume_name = "grafana-volume"
  }
}

*/

# Deploy Schema Registry (for Avro)
resource "kubernetes_deployment" "avro-registry"{
    metadata{
        name = "avro-registry-deployment"
        labels = {
            app = "avro-registry"
        }
    }
    depends_on = [kubernetes_deployment.kafka]
    spec{
        replicas = 1

        selector{
            match_labels = {
                app = "avro-registry"
            }
        }

        #Schema Registry Pod
        template{
            metadata{
                name = "avro-registry"
                labels = {
                    app = "avro-registry"
                }
            }

            spec{
                
                #Schema Registry container
                container{
                    image = "confluentinc/cp-schema-registry:5.5.1"
                    name = "avro-registry"

                     env{
                        name = "SCHEMA_REGISTRY_HOST_NAME"
                        value = "localhost"
                    }

                    env{
                        name = "SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL"
                        value = "zoo1:2181"
                    }

                    env{
                        name = "SCHEMA_REGISTRY_LISTENERS"
                        value = "http://0.0.0.0:9081"
                    }
                }
            }
        }
    }
}

# Deploy Zookeeper
resource "kubernetes_deployment" "zookeeper" {
    metadata{
        name = "zookeeper-deployment"
        labels = {
            app = "zookeeper"
        }
    }

    spec{
        replicas = 1

        selector{
            match_labels = {
                app = "zookeeper"
            }
        }

        #Zookeeper pod
        template{
            metadata{
                name="zookeeper"
                labels = {
                    app = "zookeeper"
                }
            }

            spec{
                # Zookeeper container
                container{
                    image = "bitnami/zookeeper:3.6.1"
                    name = "zookeeper-server"

                    env{
                        name="ZOOKEEPER_ID"
                        value=1
                    }

                    env{
                        name="ZOOKEEPER_SERVER_1"
                        value="zoo1"
                    }

                    env{
                        name="ALLOW_ANONYMOUS_LOGIN"
                        value="yes"
                    }

                    
                    port{
                        container_port = 2181
                    }
                    
                }
      
            }
        }
    }


}

#Zookeeper service
resource "kubernetes_service" "zookeeper-service"{
    metadata{
        name = "zoo1"
        labels = {
            app = "zookeeper"
        }
    }
    spec{
        port{
            name = "client"
            port = 2181
            target_port = 2181
            node_port = 30700
        }

        selector = {
                app = "zookeeper"
        }
        type = "NodePort"
        external_traffic_policy = "Local"
    }
}

#Kafka service
resource "kubernetes_service" "kafka_service"{
    metadata{
        name = "kafka"
        labels = {
            app = "kafka"
        }
    }
    spec{
        port{
            name = "kafka"
            port = 9092
            target_port = 9092
            node_port = 30701
        }

        port{
            name = "kafka2"
            port = 9093
            target_port = 9093
        }
        
        selector = {
            app = "kafka"
        }
        
        type = "NodePort"
        external_traffic_policy = "Local"

    }
}

#Schema Registry service
resource "kubernetes_service" "avro_registry"{
    metadata{
        name = "avro-registry"
        labels = {
            app = "avro-registry"
        }
    }
    spec{
        port{
            name = "avro-registry"
            port = 9081
            target_port = 9081
            node_port = 30702
        }

        selector = {
            app = "avro-registry"
        }

        type = "NodePort"
        external_traffic_policy = "Local"
    }
}

#Elassandra Service
resource "kubernetes_service" "elassandra_service"{
    metadata{
        name = "elassandra"
        labels = {
            app = "elassandra"
        }
    }
    spec{

        selector = {
            app = "elassandra"
        }

        # Elastic Search Transport
        port{
            name = "elastic-transport"
            port = 9300
            target_port = 9300
            node_port = 30703
        }

        # Elastic Search HTTP
        port{
            name = "elastic-http"
            port = 9200
            target_port = 9200
            node_port = 30704
        }

        # Thrift Service
        port{
            name = "thrift-service"
            port = 9160
            target_port = 9160
            node_port = 30705
        }

        # Encrypted CQL
        port{
            name = "encrypted-cql"
            port = 9142
            target_port = 9142
            node_port = 30706
        }

        # CQL
        port{
            name = "cql"
            port = 9042
            target_port = 9042
            node_port = 30707
        }

        # JMX
        port{
            name = "jmx"
            port = 7199
            target_port = 7199
            node_port = 30708
        }

        # TLS intra-node communication
        port{
            name = "intra-tls"
            port = 7001
            target_port = 7001
            node_port = 30709
        }

        # Intra-node communication
        port{
            name = "intra"
            port = 7000
            target_port = 7000
            node_port = 30710
        }

        type = "NodePort"
        external_traffic_policy = "Local"
    }
}

#Grafana Service
resource "kubernetes_service" "grafana_service"{
    metadata{
        name = "grafana"
        labels={
            app = "grafana"
        }
    }

    spec{
        port{
            name = "grafana-http"
            port = 3000
            target_port = 3000
            node_port = 30711
        }

        selector = {
            app = "grafana"
        }
        type = "NodePort"
        external_traffic_policy = "Local"
    }
}